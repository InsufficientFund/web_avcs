{% load staticfiles %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Bootstrap 101 Template</title>

        <!-- Bootstrap -->
        <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
    {% csrf_token %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-5">
                <br>
                <!--<div><input type="text" id="video_name"></div>-->
                <form enctype="multipart/form-data" method="post" action="/main/upload/" id="upload_form">
            		{% for field in form %}
                        <div class="fieldWrapper">
                        {% csrf_token %}
        		        {{ field.errors }}
                        {{ field.label_tag }} {{ field }}
    			        {% if field.help_text %}
        			        <p class="help">{{ field.help_text|safe }}</p>
                        {% endif %}
                        </div>
                    {% endfor %}
                    <input type="submit" class="submit-post">
                </form>
                <br>
                <div class="row container-fluid">
                    <form name="pointform" method="post">
                        <div class="row">
                            <div class="col-md-6">
                                up&nbsp; left x = <input type="text" id="up_left_x"  name="up_left_x" size="4" />
                                y =    <input type="text" id="up_left_y"  name="up_left_y" size="4" />
                            </div>
                            <div class="col-md-6">
                                up&nbsp; right x = <input type="text" id="up_right_x"  name="up_right_x" size="4" />
                                y =  <input type="text" id="up_right_y"  name="up_right_y" size="4" /><br>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                low left x = <input type="text" id="low_left_x"  name="low_left_x" size="4" />
                                y =  <input type="text" id="low_left_y"  name="low_left_y" size="4" /><br>
                            </div>
                            <div class="col-md-6">
                                low right x = <input type="text" id="low_right_x" name="low_right_x" size="4" />
                                y = <input type="text" id="low_right_y" name="low_right_y" size="4" />
                            </div>
                        </div>
                    </form>
                </div>
                <br>
                <div class="row container-fluid">
                    <button type="button" class="btn btn-info" onclick="draw_line(event)">draw line</button>
                    <button type="button" class="btn btn-warning" onclick="clear_line(event)">clear line</button>
                    <button type="button" class="btn btn-primary" onclick="add_lane(event)">add lane</button>
                    <button type="button" class="btn btn-danger" onclick="remove_lane(event)">clear lane</button>
                </div>
                <br>
                <div class="row container-fluid">
                    <button type="button" class="btn btn-primary" onclick="send_predict(event)">predict</button>
                </div>

            </div>
            <div class="col-md-7">
                <br>
                <div id="video_name" hidden></div>
                <canvas id="pointer_div" onclick="point_it(event)" width="640" height="480"
                        style = "background-color:#6E6E6E;border:1px solid black">
                    <!--<img src="{% static 'main_app/media/tesf.png' %}" id="cross" >-->
                    <img  id="cross" style="position:relative;visibility:hidden;z-index:2;">
                </canvas>
                <div id="pos_select" hidden>0</div>
            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/jquery.form.min.js' %}"></script>
    <script language="JavaScript">

// using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getCookie('csrftoken');
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
function send_predict(event){
    var json_data = {}
    json_data["data"] = sessionStorage.getItem('lane');
    json_data["video_name"] = $("#video_name").html();
    $.ajax({
        url: "/main/predict/",
        type: "POST",
        data: JSON.stringify(json_data),//JSON.stringify(sessionStorage.getItem('lane')),
        contentType: "application/json",
        success:function(data) {
            alert(data);
        },
    });
}

function send_select(event){
    console.log('send');
    var formData = $("#select_form").serializeArray();
    $.post('/main/imp_data/', JSON.stringify(formData)).done(function (data) {
        $("#cars_image").html('');
        alert(data);
    });
}

function select_video(){
    console.log('video');
    var json_data = {}
    json_data["video_name"] = $("#video_name").html();
    $.ajax({
        url: '/main/get_sample_frame/',
        data: {video_name:$("#video_name").html()},
        contentType: "application/json",
    }).done(function(data) {
        $('#pointer_div').attr('style', 'background-image:url("/static/main_app/media/' +data+'");border:1px solid black');
        alert('ok');
    });
}

function point_it(event){
	pos_x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("pointer_div").offsetLeft;
	pos_y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("pointer_div").offsetTop;
	document.getElementById("cross").style.left = (pos_x-1) ;
	document.getElementById("cross").style.top = (pos_y-15) ;
	document.getElementById("cross").style.visibility = "visible" ;
	console.log($("#pos_select").html() );
	if ($("#pos_select").html() == '0'){
	    document.pointform.up_left_x.value = pos_x;
	    document.pointform.up_left_y.value = pos_y;
	    $("#pos_select").html('1');
	}
	else if ($("#pos_select").html() == '1'){
	    document.pointform.up_right_x.value = pos_x;
	    document.pointform.up_right_y.value = pos_y;
	    $("#pos_select").html('2');
	}
	else if ($("#pos_select").html() == '2'){
	    document.pointform.low_left_x.value = pos_x;
	    document.pointform.low_left_y.value = pos_y;
	    $("#pos_select").html('3');
	}
	else if ($("#pos_select").html() == '3'){
	    document.pointform.low_right_x.value = pos_x;
	    document.pointform.low_right_y.value = pos_y;
	    $("#pos_select").html('0');
	}
}

function draw_line(event){
    var canvas = document.getElementById("pointer_div");
    var ctx = canvas.getContext("2d");

    var ulx = $("#up_left_x").val();
    var urx = $("#up_right_x").val();
    var llx = $("#low_left_x").val();
    var lrx = $("#low_right_x").val();

    var uly = $("#up_left_y").val();
    var ury = $("#up_right_y").val();
    var lly = $("#low_left_y").val();
    var lry = $("#low_right_y").val();
    ctx.beginPath();
    ctx.moveTo(ulx, uly);
    ctx.lineTo(urx, ury);
    ctx.lineTo(lrx, lry);
    ctx.lineTo(llx, lly);
    ctx.lineTo(ulx, uly);
    ctx.lineWidth=3;
    ctx.strokeStyle = "#01DF01";
    ctx.stroke();
}

function clear_line(event){
    var canvas = document.getElementById("pointer_div");
    var ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function add_lane(event){
    var ulx = $("#up_left_x").val();
    var urx = $("#up_right_x").val();
    var llx = $("#low_left_x").val();
    var lrx = $("#low_right_x").val();

    var uly = $("#up_left_y").val();
    var ury = $("#up_right_y").val();
    var lly = $("#low_left_y").val();
    var lry = $("#low_right_y").val();

    var laneObj ={};
    laneObj["up_left"  ] = [ulx, uly];
    laneObj["up_right" ] = [urx, ury];
    laneObj["low_left" ] = [llx, lly];
    laneObj["low_right"] = [lrx, lry];


    if(typeof Storage !== "undefined") {
        if (sessionStorage.getItem('lane')) {
            var lane = JSON.parse(sessionStorage.getItem("lane"));
            lane.push(laneObj);
            sessionStorage.setItem('lane', JSON.stringify(lane));
        } else {
            var lane = [];
            lane.push(laneObj);
            sessionStorage.setItem('lane', JSON.stringify(lane));
        }
    }
}

function upload(event) {
    event.preventDefault();
    var data = new FormData($('#upload_form').get(0));

    $.ajax({
        url: $(this).attr('action'),
        type: $(this).attr('method'),
        data: data,
        cache: false,
        processData: false,
        contentType: false,
        success: function(data) {
            $("#video_name").html(data);
            select_video();
            alert('success');
        }
    });
    return false;
}

function remove_lane(event){
    sessionStorage.removeItem('lane');
}

$(function() {
    $('#upload_form').submit(upload);
});

</script>
  </body>
</html>